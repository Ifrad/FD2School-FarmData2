<html>
  <body>
    <h1>Harvest Report</h1>
    <div id="vue-app" v-cloak>
      <!-- Title input and binding -->
      <div>
        <label for="title">Title:</label>
        <input type="text" v-model="reportTitle" placeholder="Enter report title">
      </div>
      <h1>{{ reportTitle.trim() === '' ? 'Mock Harvest Report' : reportTitle }}</h1>
      <div>
        <h3>Report Details</h3>
        <p>Farm: {{ farm }}</p>
        <p>User: {{ user }}</p>
        <p>Language: {{ language }}</p>
      </div>

      <!-- Start Date input and binding -->
      <div>
        <label for="start-date">Start:</label>
        <input type="date" v-model="reportStartDate" :max="reportEndDate" min="2014-01-01" max="2022-01-01">
      </div>

      <!-- End Date input and binding -->
      <div>
        <label for="end-date">End:</label>
        <input type="date" v-model="reportEndDate" :min="reportStartDate" min="2020-05-05" max="2022-01-01">
      </div>

      <!-- Updated Crop selection input using computed property -->
      <div>
        <label for="crop">Crop:</label>
        <select v-model="reportCrop">
          <option v-for="crop in cropNames" :key="crop">{{ crop }}</option>
        </select>
      </div>

      <!-- Area selection input and binding -->
      <div>
        <label for="area">Area:</label>
        <select v-model="reportArea">
          <option v-for="area in areas" :key="area">{{ area }}</option>
        </select>
      </div>

      <!-- Harvest Logs Table -->
      <h3>Harvest Logs</h3>

      <div v-if="harvestLogs&&harvestLogs.length > 0">
        <table border="1">
          <thead>
            <tr>
              <th>Date</th>
              <th>Area</th>
              <th>Crop</th>
              <th> Yield</th>
              <th>Units</th>
            </tr>
          </thead>
          <tbody>
            <!-- v-for to dynamically generate table rows -->
            <tr v-for="(log, index) in harvestReportRows" :key="index">
              
              <td>{{ log.date }}</td>
              <td>{{ log.area }}</td>
              <td>{{ log.crop }}</td>
              <td>{{ log.yield }}</td>
              <td>{{ log.units }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div v-else>
        No matching records found.
      </div>

      <!-- Names List -->
      <div>
        <h2>Names List</h2>
        <ul>
          <li v-if="names.length === 0">No names yet!</li>
          <li v-for="(name, index) in names" :key="name">{{ name + "(" + index + ")" }}</li>
        </ul>
      </div>

      <!-- Cards List -->
      <div>
        <h3>Cards List</h3>
        <button v-if="!showCards" @click="showCards = true">Show Cards</button>
        <button v-else @click="showCards = false">Hide Cards</button>
        
        <div v-if="showCards">
          <ul>
            <li v-for="c in cards" :key="c.suit + c.rank">{{ c.rank }} of {{ c.suit }}</li>
          </ul>
        </div>
      </div>

      <div>
        <label for="new-field">Name:</label>
        <input type="text" v-model="newField" @keyup.enter="addName" placeholder="">
        <button @click="addName" :disabled="!newField.trim()">Add Name</button>
      </div>
      <div>
        <button @click="generateReport">Generate Report</button>
      </div>
    </div>
    
    <script src="https://unpkg.com/vue@2"></script>
    
    <!-- Vue instance -->
    <script>
      var app = new Vue({
        el: "#vue-app",
        
        data: {
          reportTitle: "My Sample Harvest Report",
          reportStartDate: '2020-05-05',
          reportEndDate: '2020-05-15',
          reportCrop: '',
          reportArea: '',
          names: [],
          areas: ["All", "Chuau-1", "SQ7"],
          cards: [
            { suit: "H", rank: "3" },
            { suit: "S", rank: "K" },
            { suit: "D", rank: "7" }
          ],
          harvestLogs: [],
          harvestLogResults: [],
          newField: "",
          showCards: false,
          farm: "",
          user: "",
          language: "",
          idToCropMap: new Map()  // Added to store the crop map
          
        },
        created(){
          console.log("HarvestReport Vue instance created!");
          getIDToCropMap()
            .then((theMap) => {
              this.idToCropMap = theMap;
              console.log("crop map loaded:", this.idToCropMap);
            })
            .catch((err)=> {
              console.log("Error fetching crop map", err);
            });
        },
        computed: {
          cropNames() {
            return this.idToCropMap ? Array.from(this.idToCropMap.values()) : [];
          },
          harvestReportRows(){
            let tableRows=[];
            for(let log of this.harvestLogs){
                let tableRow={
                    date:dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                    area: log.area[0].name,
                    crop:this.idToCropMap.get(log.data.crop_tid),
                    yield: log.quantity[0].value,
                    units:log.quantity[0].unit.name,

                };
                if (this.reportCrop==="All" || tableRow.crop===this.reportCrop){
                    tableRows.push(tableRow);
                }
                

                
            }
            return tableRows;
          }
          
        },
          
         
        

        methods: {
          addName: function() {
            const trimmedName = this.newField.trim();
            if (trimmedName) {
              this.names.push(trimmedName);
              this.newField = '';
            }
          },
          generateReport: function() {
            axios.get('/farm.json')
                .then((response) => {
                    // Set farm details from the response data
                    this.reportFarm = response.data.name;
                    this.reportUser = response.data.user.name;
                    this.reportLanguage = response.data.user.language;
                    this.harvestLogs = response.data.harvestLogs;  // Update this with the correct key from the API response
                })
                .catch((err) => {
                    console.error('Error fetching farm data:', err);
                });
            let startTimestamp = dayjs(this.reportStartDate).unix();
            let endTimestamp = dayjs(this.reportEndDate).unix();
            console.log("Start TimeStamp: ",startTimestamp);
            console.log("End Timestamp",endTimestamp);

            let requestString = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;

    // Log the request string
            console.log('Request String:', requestString);
            this.harvestLogResults=[];
         
            getAllPages(requestString, this.harvestLogResults)
            .then(() => {
            // Log retrieved harvest logs
                console.log("All harvest logs retrieved:", this.harvestLogResults);
                this.harvestLogs=this.harvestLogResults;
            
          })
            .catch((err) => {
                console.log("Error occurred during the request:", err);
          });
      }
    }
});



       
      Vue.config.devtools = true;
    </script>
  </body>
</html>


